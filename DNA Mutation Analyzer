import streamlit as st
import matplotlib.pyplot as plt

# ë¶„ì„ í•¨ìˆ˜
def compare(ref, seq):
    mutations = []
    i = j = 0
    pos = 1
    while i < len(ref) and j < len(seq):
        if ref[i].upper() != seq[j].upper():
            mutations.append((pos, ref[i].upper(), seq[j].upper(), 'substitution'))
        i += 1
        j += 1
        pos += 1
    while i < len(ref):
        mutations.append((pos, ref[i].upper(), '-', 'deletion'))
        i += 1
        pos += 1
    while j < len(seq):
        mutations.append((pos, '-', seq[j].upper(), 'insertion'))
        j += 1
        pos += 1
    return mutations

def summarize(mutations, length):
    result = []
    for pos, ref_base, seq_base, mtype in mutations:
        result.append(f"{pos} {mtype.upper()} {ref_base}>{seq_base}")
    result.append(f"\nTotal: {len(mutations)}")
    result.append(f"Ratio: {(len(mutations)/length)*100:.2f}%")
    return result

def visualize(mutations, length):
    if not mutations:
        return None
    positions = [pos for pos, _, _, _ in mutations]
    fig, ax = plt.subplots(figsize=(8, 1))
    ax.eventplot(positions, orientation='horizontal', colors='#497325')
    ax.set_xlim(1, length + 1)
    ax.set_xlabel("Position")
    ax.set_yticks([])
    return fig

# Streamlit UI
st.set_page_config(layout="wide")
st.markdown("<h1 style='color:#497325;'>ğŸ§¬ DNA Mutation Analyzer</h1>", unsafe_allow_html=True)

# ì‚¬ìš©ì ì…ë ¥
ref = st.text_area("ğŸ”¬ Reference Sequence", height=100)
seq = st.text_area("ğŸ§¬ Mutated Sequence", height=100)

# ë²„íŠ¼ í´ë¦­ ì‹œ ë¶„ì„ ê²°ê³¼ ì €ì¥
if st.button("ğŸŸ¢ Analyze"):
    if ref and seq:
        st.session_state["mutations"] = compare(ref, seq)
        st.session_state["length"] = len(ref)
    else:
        st.warning("âš ï¸ ë‘ ì‹œí€€ìŠ¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# ê²°ê³¼ ì¶œë ¥
if "mutations" in st.session_state:
    st.markdown("## ğŸ“‹ Mutation Summary")
    for line in summarize(st.session_state["mutations"], st.session_state["length"]):
        st.text(line)

    fig = visualize(st.session_state["mutations"], st.session_state["length"])
    if fig:
        st.pyplot(fig)
